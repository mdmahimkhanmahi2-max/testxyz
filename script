#!/bin/bash
set -euo pipefail

# =====================================================
# Enhanced Multi-VM Manager
# Made by MahimOp
# Edited by MahimOp
# =====================================================

# =============================
# Colors & Emojis
# =============================
RED="\033[0;31m"
GREEN="\033[0;32m"
YELLOW="\033[1;33m"
BLUE="\033[0;34m"
NC="\033[0m"

print_status() {
    local type=$1
    local msg=$2
    case "$type" in
        "INFO") echo -e "${BLUE}ðŸ“Œ [INFO]${NC} $msg" ;;
        "SUCCESS") echo -e "${GREEN}âœ… [SUCCESS]${NC} $msg" ;;
        "WARN") echo -e "${YELLOW}âš ï¸ [WARN]${NC} $msg" ;;
        "ERROR") echo -e "${RED}âŒ [ERROR]${NC} $msg" ;;
        "INPUT") echo -ne "${BLUE}ðŸ’¡ [INPUT]${NC} $msg " ;;
    esac
}

# =============================
# VM Directory
# =============================
VM_DIR="$HOME/vms"
mkdir -p "$VM_DIR"

# =============================
# Save & Load VM Config
# =============================
save_vm_config() {
    cat > "$VM_DIR/$VM_NAME.conf" << EOF
HOSTNAME="$HOSTNAME"
USERNAME="$USERNAME"
PASSWORD="$PASSWORD"
DISK_SIZE="$DISK_SIZE"
MEMORY="$MEMORY"
CPUS="$CPUS"
SSH_PORT="$SSH_PORT"
GUI_MODE="$GUI_MODE"
PORT_FORWARDS="$PORT_FORWARDS"
IMG_FILE="$IMG_FILE"
SEED_FILE="$SEED_FILE"
EOF
}

load_vm_config() {
    local vm_name=$1
    if [[ ! -f "$VM_DIR/$vm_name.conf" ]]; then
        print_status "ERROR" "VM '$vm_name' does not exist."
        return 1
    fi
    source "$VM_DIR/$vm_name.conf"
    VM_NAME="$vm_name"
    return 0
}

# =============================
# Create VM
# =============================
create_vm() {
    print_status "INFO" "Creating new VM..."
    read -p "$(print_status "INPUT" "VM Name: ")" VM_NAME
    VM_PATH="$VM_DIR/$VM_NAME"
    mkdir -p "$VM_PATH"

    read -p "$(print_status "INPUT" "Hostname: ")" HOSTNAME
    read -p "$(print_status "INPUT" "Username: ")" USERNAME
    read -s -p "$(print_status "INPUT" "Password (hidden): ")" PASSWORD; echo
    read -p "$(print_status "INPUT" "Disk size (GB, e.g., 10): ")" DISK_SIZE
    read -p "$(print_status "INPUT" "Memory (MB, e.g., 2048): ")" MEMORY
    read -p "$(print_status "INPUT" "CPUs: ")" CPUS
    read -p "$(print_status "INPUT" "SSH port: ")" SSH_PORT
    read -p "$(print_status "INPUT" "GUI mode (y/n): ")" gui; [[ "$gui" =~ ^[Yy]$ ]] && GUI_MODE=true || GUI_MODE=false
    read -p "$(print_status "INPUT" "Port forwards (comma-separated, e.g., 8080,3306): ")" PORT_FORWARDS

    IMG_FILE="$VM_PATH/disk.qcow2"
    SEED_FILE="$VM_PATH/seed.iso"

    print_status "INFO" "Creating disk image..."
    qemu-img create -f qcow2 "$IMG_FILE" "${DISK_SIZE}G"

    print_status "SUCCESS" "VM '$VM_NAME' created successfully!"
    save_vm_config
}

# =============================
# Start VM
# =============================
start_vm() {
    local vm_name=$1
    if ! load_vm_config "$vm_name"; then return 1; fi

    print_status "INFO" "Starting VM '$VM_NAME'..."
    local gui_flag="-nographic"
    $([[ "$GUI_MODE" == true ]] && gui_flag="-display gtk,show-cursor=on")

    local pf_string=""
    if [[ -n "$PORT_FORWARDS" ]]; then
        IFS=',' read -ra ports <<< "$PORT_FORWARDS"
        for p in "${ports[@]}"; do
            pf_string+="-net user,hostfwd=tcp::$p-:$p -net nic "
        done
    fi

    qemu-system-x86_64 \
        -m "$MEMORY" -smp "$CPUS" \
        -drive file="$IMG_FILE",format=qcow2 \
        -cdrom "$SEED_FILE" \
        -net nic -net user,hostfwd=tcp::$SSH_PORT-:22 \
        $pf_string \
        $gui_flag &

    print_status "SUCCESS" "VM '$VM_NAME' started. SSH port: $SSH_PORT"
}

# =============================
# Stop VM
# =============================
stop_vm() {
    local vm_name=$1
    if ! load_vm_config "$vm_name"; then return 1; fi

    local pid
    pid=$(pgrep -f "$IMG_FILE" || true)
    if [[ -z "$pid" ]]; then
        print_status "WARN" "VM '$VM_NAME' is not running."
        return 0
    fi

    kill "$pid" && print_status "SUCCESS" "VM '$VM_NAME' stopped."
}

# =============================
# Delete VM
# =============================
delete_vm() {
    local vm_name=$1
    if ! load_vm_config "$vm_name"; then return 1; fi

    read -p "$(print_status "INPUT" "Are you sure you want to DELETE VM '$VM_NAME'? (y/n): ")" confirm
    if [[ ! "$confirm" =~ ^[Yy]$ ]]; then
        print_status "INFO" "Deletion aborted."
        return 0
    fi

    stop_vm "$VM_NAME" || true
    rm -rf "$VM_DIR/$VM_NAME"
    print_status "SUCCESS" "VM '$VM_NAME' deleted."
}

# =============================
# Edit VM
# =============================
edit_vm_config() {
    local vm_name=$1
    if ! load_vm_config "$vm_name"; then return 1; fi

    print_status "INFO" "Editing VM '$VM_NAME' config..."
    read -p "$(print_status "INPUT" "Hostname ($HOSTNAME): ")" input; [[ -n "$input" ]] && HOSTNAME="$input"
    read -p "$(print_status "INPUT" "Username ($USERNAME): ")" input; [[ -n "$input" ]] && USERNAME="$input"
    read -s -p "$(print_status "INPUT" "Password (hidden): ")" input; [[ -n "$input" ]] && PASSWORD="$input"; echo
    read -p "$(print_status "INPUT" "Disk size ($DISK_SIZE): ")" input; [[ -n "$input" ]] && DISK_SIZE="$input"
    read -p "$(print_status "INPUT" "Memory ($MEMORY): ")" input; [[ -n "$input" ]] && MEMORY="$input"
    read -p "$(print_status "INPUT" "CPUs ($CPUS): ")" input; [[ -n "$input" ]] && CPUS="$input"
    read -p "$(print_status "INPUT" "SSH port ($SSH_PORT): ")" input; [[ -n "$input" ]] && SSH_PORT="$input"
    read -p "$(print_status "INPUT" "GUI mode ($GUI_MODE, y/n): ")" input; [[ "$input" =~ ^[Yy]$ ]] && GUI_MODE=true || [[ "$input" =~ ^[Nn]$ ]] && GUI_MODE=false
    read -p "$(print_status "INPUT" "Port forwards ($PORT_FORWARDS): ")" input; [[ -n "$input" ]] && PORT_FORWARDS="$input"

    save_vm_config
    print_status "SUCCESS" "VM '$VM_NAME' configuration updated."
}

# =============================
# Main Menu
# =============================
main_menu() {
    while true; do
        clear
        echo -e "${GREEN}=============================="
        echo " Enhanced Multi-VM Manager "
        echo " Made by MahimOp | Edited by MahimOp "
        echo -e "==============================${NC}"
        echo "1) Create VM"
        echo "2) Start VM"
        echo "3) Stop VM"
        echo "4) Edit VM"
        echo "5) Delete VM"
        echo "6) List VMs"
        echo "7) Exit"
        read -p "Choose an option: " choice
        case $choice in
            1) create_vm ;;
            2) read -p "VM Name: " vm; start_vm "$vm" ;;
            3) read -p "VM Name: " vm; stop_vm "$vm" ;;
            4) read -p "VM Name: " vm; edit_vm_config "$vm" ;;
            5) read -p "VM Name: " vm; delete_vm "$vm" ;;
            6) ls -1 "$VM_DIR" ;;
            7) exit 0 ;;
            *) print_status "WARN" "Invalid option." ;;
        esac
        read -p "Press Enter to continue..." dummy
    done
}

# =============================
# Run Menu
# =============================
main_menu
